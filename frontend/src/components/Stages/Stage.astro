---
import type { Stage } from "../../types";
import Card from "../Card/Card.astro";

interface Props extends Stage {
  initiallyShown: boolean;
}

const { options, priceMod, title, initiallyShown } = Astro.props;
---

<script>
  import useMainPageStore, {
    subscribeToCurrentStage,
  } from "../../stores/mainPage/mainPage";

  import { Cards } from "../Card/Cards";

  const { selectCard, initialize } = useMainPageStore.getState();

  let cleanCards: VoidFunction | null = null;
  subscribeToCurrentStage((stage, prevStage) => {
    cleanCards?.();
    if (prevStage) {
      prevStage.classList.add("hidden");
    }
    if (stage) {
      stage.classList.remove("hidden");
      const cards = Cards.getFrom(stage);
      cleanCards = cards.addHandlers("click", selectCard);
    } else console.error("No stage found");
  });

  initialize(Array.from(document.querySelectorAll(".stage")));
</script>

<div
  class:list={[
    "stage",
    "flex",
    "flex-col",
    "justify-around",
    "bg-slate-400",
		"h-full",
    { hidden: !initiallyShown },
  ]}
>
  <h2 class='justify-around'>{title}</h2>
  <div
    class='flex motion-safe:animate-appear-300 w-full justify-center flex-wrap gap-4 px-2'
  >
    {options.map((card, i) => <Card {...card} priceMod={priceMod} index={i} length={options.length} />)}
  </div>
</div>
