---
import { stages } from "./mock";
import Stage from "../Stage/Stage.astro";
import Price from "../Price/Price.astro";
---

<script>
  import { stage } from "../../utils/stages";
  import { Cards } from "../Card/Cards";
  import { getCalculatedPrice, setPriceAmount } from "../Price/price-client";
  import {
    handleNextStage,
    initializeStage,
    makeChoice,
  } from "./stageProgression";

  function stageChoiceHandler(card: HTMLElement) {
    makeChoice(card.id);
    const { priceMod, value } = Cards.getDataFromCard(card);
    console.log(priceMod, value);
    setPriceAmount(getCalculatedPrice(priceMod, value));
    const cards = handleNextStage(stageChoiceHandler);
    cards?.updateCardPrices();
  }

  if (stage.current) {
    initializeStage(stage.current, stageChoiceHandler);
  }
</script>

<header>
  <Price />
</header>
<main>
  {stages.map((props, i) => <Stage {...props} initiallyShown={i === 0} />)}
</main>
